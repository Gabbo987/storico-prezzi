<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Storico Prezzi">
    <meta name="theme-color" content="#007AFF">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23007AFF' width='100' height='100' rx='20'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>‚Ç¨</text></svg>">
    <title>Storico Prezzi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-color: #007AFF;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --background: #F2F2F7;
            --card-background: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border-color: #C6C6C8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            padding-bottom: env(safe-area-inset-bottom);
            overscroll-behavior: none;
        }

        .app-container {
            max-width: 100vw;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            background: var(--card-background);
            padding: max(20px, env(safe-area-inset-top)) 20px 15px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
        }

        .tab-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .tab-button.active {
            color: var(--primary-color);
        }

        .tab-icon {
            font-size: 24px;
        }

        /* Content Sections */
        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        /* Product Item */
        .product-item {
            background: var(--card-background);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .product-name {
            font-size: 17px;
            font-weight: 600;
            flex: 1;
            margin-right: 12px;
        }

        .product-price-container {
            text-align: right;
        }

        .original-price {
            font-size: 13px;
            color: var(--text-secondary);
            text-decoration: line-through;
            margin-bottom: 2px;
        }

        .product-price {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .product-price.discounted {
            color: var(--success-color);
        }

        .product-details {
            display: flex;
            gap: 16px;
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .discount-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #FFF3E0;
            color: var(--warning-color);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            opacity: 0.6;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: var(--background);
            color: var(--primary-color);
        }

        .floating-add-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(0,122,255,0.4);
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 17px;
            background: var(--card-background);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Autocomplete suggestions */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 4px;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--background);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:active {
            background: var(--background);
        }

        .autocomplete-icon {
            font-size: 18px;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--card-background);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Shopping Session Info */
        .session-info {
            background: #E3F2FD;
            border: 1px solid #90CAF9;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-details {
            flex: 1;
        }

        .session-store {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2px;
        }

        .session-date {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Quick Add */
        .quick-add-section {
            margin-bottom: 20px;
        }

        .quick-add-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .quick-add-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .quick-add-item {
            background: var(--card-background);
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-add-item:active {
            transform: scale(0.95);
            border-color: var(--primary-color);
        }

        .quick-add-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .quick-add-brand {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .quick-add-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Charts */
        .chart-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .chart-filter-btn {
            padding: 8px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 20px;
            background: var(--card-background);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .chart-canvas {
            width: 100%;
            height: 250px;
            margin-top: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Toggle */
        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .toggle {
            width: 51px;
            height: 31px;
            background: var(--border-color);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--success-color);
        }

        .toggle-slider {
            width: 27px;
            height: 27px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle.active .toggle-slider {
            transform: translateX(20px);
        }

        /* Segmented Control */
        .segmented-control {
            display: flex;
            background: var(--background);
            border-radius: 10px;
            padding: 2px;
            margin-bottom: 12px;
        }

        .segment {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .segment.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: flex-end;
        }

        .modal-content {
            background: var(--card-background);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            font-size: 28px;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), #0051D5);
            border-radius: 12px;
            padding: 20px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Search */
        .search-bar {
            background: var(--background);
            border-radius: 10px;
            padding: 8px 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 17px;
            outline: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* List Section */
        .section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 24px 0 12px;
        }

        /* Price History Chart */
        .chart-container {
            background: var(--card-background);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .mini-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 60px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary-color), #64B5F6);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .sort-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            background: var(--card-background);
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1 id="pageTitle">Storico Prezzi</h1>
        </div>

        <!-- Products Tab -->
        <div id="productsTab" class="tab-content active">
            <!-- Quick Add Section -->
            <div class="quick-add-section" id="quickAddSection" style="display: none;">
                <div class="quick-add-title">AGGIUNGI VELOCE</div>
                <div class="quick-add-grid" id="quickAddGrid"></div>
            </div>

            <div class="search-bar">
                <span>üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Cerca prodotto o negozio">
            </div>

            <select class="sort-select" id="sortSelect">
                <option value="date-desc">Data (recente)</option>
                <option value="date-asc">Data (meno recente)</option>
                <option value="name-asc">Nome (A-Z)</option>
                <option value="name-desc">Nome (Z-A)</option>
                <option value="price-asc">Prezzo (crescente)</option>
                <option value="price-desc">Prezzo (decrescente)</option>
            </select>

            <div id="productsList"></div>

            <button class="floating-add-btn" onclick="openAddModal()">+</button>
        </div>

        <!-- Statistics Tab -->
        <div id="statsTab" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSpent">‚Ç¨0.00</div>
                    <div class="stat-label">Totale speso</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPurchases">0</div>
                    <div class="stat-label">Acquisti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPrice">‚Ç¨0.00</div>
                    <div class="stat-label">Prezzo medio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniqueProducts">0</div>
                    <div class="stat-label">Prodotti unici</div>
                </div>
            </div>

            <!-- Total Spending Chart -->
            <div class="chart-container">
                <div class="chart-title">üìä Spesa Totale nel Tempo</div>
                <div class="chart-filters">
                    <button class="chart-filter-btn active" onclick="updateSpendingChart('week')">Settimana</button>
                    <button class="chart-filter-btn" onclick="updateSpendingChart('month')">Mese</button>
                    <button class="chart-filter-btn" onclick="updateSpendingChart('year')">Anno</button>
                </div>
                <select class="sort-select" id="spendingStoreFilter" onchange="updateSpendingChart()">
                    <option value="">Tutti i negozi</option>
                </select>
                <canvas id="spendingChart" class="chart-canvas"></canvas>
            </div>

            <!-- Product Price Chart -->
            <div class="chart-container">
                <div class="chart-title">üí∞ Prezzo Prodotto nel Tempo</div>
                <select class="sort-select" id="productChartSelect" onchange="updateProductChart()">
                    <option value="">Seleziona un prodotto</option>
                </select>
                <select class="sort-select" id="productStoreFilter" onchange="updateProductChart()" style="margin-top: 8px;">
                    <option value="">Tutti i negozi</option>
                </select>
                <canvas id="productChart" class="chart-canvas"></canvas>
            </div>

            <div class="section-header">PRODOTTI PI√ô ACQUISTATI</div>
            <div id="topProductsList"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="card">
                <h3 style="margin-bottom: 16px;">Gestione Dati</h3>
                <button class="btn btn-primary" onclick="exportData()" style="margin-bottom: 12px;">
                    <span>üì§</span> Esporta Dati
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                    <span>üì•</span> Importa Dati
                </button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>

            <div class="card">
                <h3 style="margin-bottom: 12px;">Informazioni</h3>
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                    <span style="color: var(--text-secondary);">Prodotti registrati</span>
                    <span id="totalProductsCount">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                    <span style="color: var(--text-secondary);">Versione</span>
                    <span>1.0.0</span>
                </div>
            </div>

            <div class="card">
                <button class="btn btn-danger" onclick="deleteAllData()">
                    üóëÔ∏è Elimina Tutti i Dati
                </button>
            </div>

            <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
                <p>Tutti i dati sono salvati localmente sul tuo dispositivo.</p>
                <p style="margin-top: 8px;">Per installare come app: tocca Condividi ‚Üí Aggiungi a Home</p>
            </div>
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-button active" onclick="switchTab('products')">
                <div class="tab-icon">üìã</div>
                <div>Prodotti</div>
            </button>
            <button class="tab-button" onclick="switchTab('stats')">
                <div class="tab-icon">üìä</div>
                <div>Statistiche</div>
            </button>
            <button class="tab-button" onclick="switchTab('settings')">
                <div class="tab-icon">‚öôÔ∏è</div>
                <div>Impostazioni</div>
            </button>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="quickAddTitle">Aggiungi Veloce</h2>
                <button class="modal-close" onclick="closeQuickAddModal()">√ó</button>
            </div>
            
            <form id="quickAddForm" onsubmit="saveQuickAdd(event)">
                <div class="card" style="background: #F0F9FF; border: 1px solid #BAE6FD; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;" id="quickProductName"></div>
                    <div style="color: var(--text-secondary); font-size: 14px;" id="quickProductBrand"></div>
                    <div style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">
                        Ultimo: <span style="font-weight: 600; color: var(--primary-color);" id="quickLastPrice"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Prezzo (‚Ç¨)</label>
                    <input type="number" class="form-input" id="quickPrice" step="0.01" min="0" required placeholder="0.00" autofocus>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Data Acquisto</label>
                    <input type="date" class="form-input" id="quickDate" required>
                </div>
                
                <div class="form-group autocomplete-container">
                    <label class="form-label">Negozio</label>
                    <input type="text" class="form-input" id="quickStore" required placeholder="es. Conad">
                    <div id="quickStoreSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    ‚úÖ Aggiungi
                </button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nuovo Prodotto</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>

            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="editingId">

                <!-- Mode Toggle -->
                <div class="mode-toggle">
                    <button type="button" class="mode-btn active" id="singleModeBtn" onclick="switchMode('single')">
                        üì¶ Prodotto Singolo
                    </button>
                    <button type="button" class="mode-btn" id="shoppingModeBtn" onclick="switchMode('shopping')">
                        üõí Spesa Completa
                    </button>
                </div>

                <!-- Shopping Session Info (shown only in shopping mode) -->
                <div id="sessionInfo" class="session-info" style="display: none;">
                    <div class="session-details">
                        <div class="session-store" id="sessionStore">-</div>
                        <div class="session-date" id="sessionDate">-</div>
                    </div>
                    <button type="button" class="session-close" onclick="endShoppingSession()">Termina</button>
                </div>

                <!-- Shopping Session Setup (shown only when starting shopping mode) -->
                <div id="sessionSetup" style="display: none;">
                    <div class="form-group autocomplete-container">
                        <label class="form-label">Negozio</label>
                        <input type="text" class="form-input" id="sessionStoreName" placeholder="es. Conad, Esselunga">
                        <div id="sessionStoreSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Data Spesa</label>
                        <input type="date" class="form-input" id="sessionDateInput">
                    </div>

                    <button type="button" class="btn btn-primary" onclick="startShoppingSession()">
                        ‚ñ∂Ô∏è Inizia Spesa
                    </button>
                    
                    <div style="height: 12px;"></div>
                </div>

                <!-- Product Fields -->
                <div id="productFields">
                    <div class="form-group autocomplete-container">
                        <label class="form-label">Nome Prodotto</label>
                        <input type="text" class="form-input" id="productName" required placeholder="es. Pasta">
                        <div id="nameSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                    </div>

                    <div class="form-group autocomplete-container">
                        <label class="form-label">Marca</label>
                        <input type="text" class="form-input" id="productBrand" required placeholder="es. Barilla, De Cecco">
                        <div id="brandSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Prezzo (‚Ç¨)</label>
                        <input type="number" class="form-input" id="productPrice" step="0.01" min="0" required placeholder="0.00">
                    </div>

                    <div id="singleModeFields">
                        <div class="form-group">
                            <label class="form-label">Data Acquisto</label>
                            <input type="date" class="form-input" id="purchaseDate" required>
                        </div>

                        <div class="form-group autocomplete-container">
                            <label class="form-label">Negozio</label>
                            <input type="text" class="form-input" id="storeName" required placeholder="es. Conad, Esselunga">
                            <div id="storeSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                        </div>
                    </div>

                <div class="form-group">
                    <div class="toggle-container">
                        <label class="form-label" style="margin: 0;">Applica Sconto</label>
                        <div class="toggle" id="discountToggle" onclick="toggleDiscount()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div id="discountSection" style="display: none;">
                    <div class="segmented-control" id="discountTypeControl">
                        <button type="button" class="segment active" onclick="selectDiscountType('amount')">Importo (‚Ç¨)</button>
                        <button type="button" class="segment" onclick="selectDiscountType('percentage')">Percentuale (%)</button>
                    </div>

                    <div class="form-group" id="discountAmountGroup">
                        <label class="form-label">Importo Sconto (‚Ç¨)</label>
                        <input type="number" class="form-input" id="discountAmount" step="0.01" min="0" placeholder="0.00">
                    </div>

                    <div class="form-group" id="discountPercentageGroup" style="display: none;">
                        <label class="form-label">Percentuale Sconto (%)</label>
                        <input type="number" class="form-input" id="discountPercentage" step="1" min="0" max="100" placeholder="0">
                    </div>

                    <div class="card" style="background: #F0F9FF; border: 1px solid #BAE6FD; margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Prezzo finale:</span>
                            <span id="finalPricePreview" style="font-size: 20px; font-weight: 700; color: var(--success-color);">‚Ç¨0.00</span>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 24px;">
                    <span id="saveButtonText">üíæ Salva Prodotto</span>
                </button>

                <!-- Add Another Button (only in shopping mode) -->
                <button type="button" class="btn btn-secondary" id="addAnotherBtn" style="margin-top: 12px; display: none;" onclick="addAnotherProduct()">
                    ‚ûï Aggiungi Altro Prodotto
                </button>
            </form>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Dettaglio</h2>
                <button class="modal-close" onclick="closeDetailModal()">√ó</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let products = JSON.parse(localStorage.getItem('priceHistory') || '[]');
        let currentDiscountType = 'amount';
        let editingProductId = null;
        let currentMode = 'single'; // 'single' or 'shopping'
        let shoppingSession = null; // { store, date }
        let spendingChartInstance = null;
        let productChartInstance = null;
        let currentSpendingPeriod = 'week';
        let quickAddProduct = null;

        // Migrate old data to add brand field
        function migrateData() {
            let needsMigration = false;
            products = products.map(p => {
                if (!p.hasOwnProperty('brand')) {
                    needsMigration = true;
                    return { ...p, brand: '' };
                }
                return p;
            });
            
            if (needsMigration) {
                localStorage.setItem('priceHistory', JSON.stringify(products));
                console.log('Data migrated to include brand field');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            migrateData();
            
            document.getElementById('purchaseDate').valueAsDate = new Date();
            document.getElementById('sessionDateInput').valueAsDate = new Date();
            document.getElementById('quickDate').valueAsDate = new Date();
            
            renderProducts();
            updateStats();
            updateQuickAdd();
            
            // Search and sort listeners
            document.getElementById('searchInput').addEventListener('input', renderProducts);
            document.getElementById('sortSelect').addEventListener('change', renderProducts);
            
            // Price change listeners
            document.getElementById('productPrice').addEventListener('input', updateFinalPricePreview);
            document.getElementById('discountAmount').addEventListener('input', updateFinalPricePreview);
            document.getElementById('discountPercentage').addEventListener('input', updateFinalPricePreview);
            
            // Autocomplete listeners
            setupAutocomplete('productName', 'nameSuggestions', getProductNameSuggestions);
            setupAutocomplete('productBrand', 'brandSuggestions', getBrandSuggestions);
            setupAutocomplete('storeName', 'storeSuggestions', getStoreSuggestions);
            setupAutocomplete('sessionStoreName', 'sessionStoreSuggestions', getStoreSuggestions);
            setupAutocomplete('quickStore', 'quickStoreSuggestions', getStoreSuggestions);
        });

        // Autocomplete functionality
        function setupAutocomplete(inputId, suggestionsId, getSuggestionsFunc) {
            const input = document.getElementById(inputId);
            const suggestionsDiv = document.getElementById(suggestionsId);
            
            input.addEventListener('input', function() {
                const value = this.value.trim();
                if (value.length < 1) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                const suggestions = getSuggestionsFunc(value);
                if (suggestions.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                suggestionsDiv.innerHTML = suggestions.map(s => `
                    <div class="autocomplete-item" onclick="selectSuggestion('${inputId}', '${s.value.replace(/'/g, "\\'")}')">
                        <span class="autocomplete-icon">${s.icon}</span>
                        <span>${s.label}</span>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            });
            
            input.addEventListener('blur', function() {
                setTimeout(() => suggestionsDiv.style.display = 'none', 200);
            });
        }

        function getProductNameSuggestions(query) {
            const names = [...new Set(products.map(p => p.name))];
            return names
                .filter(name => name.toLowerCase().includes(query.toLowerCase()))
                .slice(0, 5)
                .map(name => ({ value: name, label: name, icon: 'üì¶' }));
        }

        function getBrandSuggestions(query) {
            const brands = [...new Set(products.map(p => p.brand).filter(b => b))];
            return brands
                .filter(brand => brand.toLowerCase().includes(query.toLowerCase()))
                .slice(0, 5)
                .map(brand => ({ value: brand, label: brand, icon: 'üè∑Ô∏è' }));
        }

        function getStoreSuggestions(query) {
            const stores = [...new Set(products.map(p => p.store))];
            return stores
                .filter(store => store.toLowerCase().includes(query.toLowerCase()))
                .slice(0, 5)
                .map(store => ({ value: store, label: store, icon: 'üè™' }));
        }

        function selectSuggestion(inputId, value) {
            document.getElementById(inputId).value = value;
            document.getElementById(inputId).focus();
        }

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            
            document.getElementById('singleModeBtn').classList.toggle('active', mode === 'single');
            document.getElementById('shoppingModeBtn').classList.toggle('active', mode === 'shopping');
            
            if (mode === 'shopping') {
                if (shoppingSession) {
                    // Session already active
                    document.getElementById('sessionSetup').style.display = 'none';
                    document.getElementById('sessionInfo').style.display = 'flex';
                    document.getElementById('singleModeFields').style.display = 'none';
                    document.getElementById('productFields').style.display = 'block';
                    document.getElementById('addAnotherBtn').style.display = 'block';
                    document.getElementById('saveButtonText').textContent = '‚úÖ Aggiungi e Continua';
                } else {
                    // Show session setup
                    document.getElementById('sessionSetup').style.display = 'block';
                    document.getElementById('sessionInfo').style.display = 'none';
                    document.getElementById('productFields').style.display = 'none';
                    document.getElementById('addAnotherBtn').style.display = 'none';
                }
            } else {
                // Single mode
                document.getElementById('sessionSetup').style.display = 'none';
                document.getElementById('sessionInfo').style.display = 'none';
                document.getElementById('singleModeFields').style.display = 'block';
                document.getElementById('productFields').style.display = 'block';
                document.getElementById('addAnotherBtn').style.display = 'none';
                document.getElementById('saveButtonText').textContent = 'üíæ Salva Prodotto';
            }
        }

        function startShoppingSession() {
            const store = document.getElementById('sessionStoreName').value.trim();
            const date = document.getElementById('sessionDateInput').value;
            
            if (!store || !date) {
                alert('Inserisci negozio e data');
                return;
            }
            
            shoppingSession = { store, date };
            
            document.getElementById('sessionStore').textContent = store;
            document.getElementById('sessionDate').textContent = formatDate(date);
            
            document.getElementById('sessionSetup').style.display = 'none';
            document.getElementById('sessionInfo').style.display = 'flex';
            document.getElementById('productFields').style.display = 'block';
            document.getElementById('addAnotherBtn').style.display = 'block';
            document.getElementById('saveButtonText').textContent = '‚úÖ Aggiungi e Continua';
            
            // Focus on product name
            document.getElementById('productName').focus();
        }

        function endShoppingSession() {
            if (confirm('Terminare la spesa? I prodotti inseriti sono gi√† salvati.')) {
                shoppingSession = null;
                closeModal();
            }
        }

        function addAnotherProduct() {
            // Clear product fields but keep session
            document.getElementById('productName').value = '';
            document.getElementById('productBrand').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('discountToggle').classList.remove('active');
            document.getElementById('discountSection').style.display = 'none';
            document.getElementById('discountAmount').value = '';
            document.getElementById('discountPercentage').value = '';
            updateFinalPricePreview();
            
            // Focus on product name
            document.getElementById('productName').focus();
        }

        // Quick Add functionality
        function updateQuickAdd() {
            const productGroups = {};
            products.forEach(p => {
                const key = `${p.name}|||${p.brand}`;
                if (!productGroups[key]) {
                    productGroups[key] = [];
                }
                productGroups[key].push(p);
            });
            
            const topProducts = Object.entries(productGroups)
                .map(([key, purchases]) => {
                    const [name, brand] = key.split('|||');
                    const sorted = purchases.sort((a, b) => new Date(b.date) - new Date(a.date));
                    return {
                        name,
                        brand,
                        lastPrice: getFinalPrice(sorted[0]),
                        count: purchases.length,
                        lastPurchase: sorted[0]
                    };
                })
                .sort((a, b) => b.count - a.count)
                .slice(0, 6);
            
            const container = document.getElementById('quickAddGrid');
            const section = document.getElementById('quickAddSection');
            
            if (topProducts.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = topProducts.map(item => `
                <div class="quick-add-item" onclick='openQuickAdd(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                    <div class="quick-add-name">${item.name}</div>
                    <div class="quick-add-brand">${item.brand}</div>
                    <div class="quick-add-price">‚Ç¨${item.lastPrice.toFixed(2)}</div>
                </div>
            `).join('');
        }

        function openQuickAdd(item) {
            quickAddProduct = item;
            document.getElementById('quickProductName').textContent = item.name;
            document.getElementById('quickProductBrand').textContent = item.brand;
            document.getElementById('quickLastPrice').textContent = `‚Ç¨${item.lastPrice.toFixed(2)}`;
            document.getElementById('quickPrice').value = item.lastPrice.toFixed(2);
            document.getElementById('quickDate').valueAsDate = new Date();
            document.getElementById('quickStore').value = item.lastPurchase.store;
            document.getElementById('quickAddModal').classList.add('active');
            
            setTimeout(() => {
                document.getElementById('quickPrice').focus();
                document.getElementById('quickPrice').select();
            }, 100);
        }

        function closeQuickAddModal() {
            document.getElementById('quickAddModal').classList.remove('active');
            quickAddProduct = null;
        }

        function saveQuickAdd(e) {
            e.preventDefault();
            
            if (!quickAddProduct) return;
            
            const product = {
                id: Date.now().toString(),
                name: quickAddProduct.name,
                brand: quickAddProduct.brand,
                price: parseFloat(document.getElementById('quickPrice').value),
                date: document.getElementById('quickDate').value,
                store: document.getElementById('quickStore').value,
                discount: null,
                discountPercentage: null
            };
            
            products.push(product);
            localStorage.setItem('priceHistory', JSON.stringify(products));
            
            closeQuickAddModal();
            renderProducts();
            updateStats();
            updateQuickAdd();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            
            const tabs = {
                'products': { element: 'productsTab', title: 'Storico Prezzi', button: 0 },
                'stats': { element: 'statsTab', title: 'Statistiche', button: 1 },
                'settings': { element: 'settingsTab', title: 'Impostazioni', button: 2 }
            };
            
            const selected = tabs[tab];
            document.getElementById(selected.element).classList.add('active');
            document.querySelectorAll('.tab-button')[selected.button].classList.add('active');
            document.getElementById('pageTitle').textContent = selected.title;
            
            if (tab === 'stats') updateStats();
        }

        function openAddModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = currentMode === 'shopping' && shoppingSession ? 'Aggiungi Prodotto' : 'Nuovo Prodotto';
            document.getElementById('productForm').reset();
            document.getElementById('editingId').value = '';
            
            if (currentMode === 'single' || !shoppingSession) {
                document.getElementById('purchaseDate').valueAsDate = new Date();
                currentMode = 'single';
                switchMode('single');
            } else {
                switchMode('shopping');
            }
            
            document.getElementById('discountToggle').classList.remove('active');
            document.getElementById('discountSection').style.display = 'none';
            document.getElementById('addModal').classList.add('active');
            updateFinalPricePreview();
            
            // Focus appropriate field
            setTimeout(() => {
                if (currentMode === 'shopping' && shoppingSession) {
                    document.getElementById('productName').focus();
                } else if (currentMode === 'shopping' && !shoppingSession) {
                    document.getElementById('sessionStoreName').focus();
                } else {
                    document.getElementById('productName').focus();
                }
            }, 100);
        }

        function closeModal() {
            // Don't reset shopping session on close
            document.getElementById('addModal').classList.remove('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function toggleDiscount() {
            const toggle = document.getElementById('discountToggle');
            const section = document.getElementById('discountSection');
            toggle.classList.toggle('active');
            section.style.display = toggle.classList.contains('active') ? 'block' : 'none';
            updateFinalPricePreview();
        }

        function selectDiscountType(type) {
            currentDiscountType = type;
            document.querySelectorAll('#discountTypeControl .segment').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'amount') {
                document.getElementById('discountAmountGroup').style.display = 'block';
                document.getElementById('discountPercentageGroup').style.display = 'none';
            } else {
                document.getElementById('discountAmountGroup').style.display = 'none';
                document.getElementById('discountPercentageGroup').style.display = 'block';
            }
            updateFinalPricePreview();
        }

        function updateFinalPricePreview() {
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            let finalPrice = price;
            
            if (document.getElementById('discountToggle').classList.contains('active')) {
                if (currentDiscountType === 'amount') {
                    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
                    finalPrice = Math.max(0, price - discount);
                } else {
                    const percentage = parseFloat(document.getElementById('discountPercentage').value) || 0;
                    finalPrice = price * (1 - percentage / 100);
                }
            }
            
            document.getElementById('finalPricePreview').textContent = `‚Ç¨${finalPrice.toFixed(2)}`;
        }

        function saveProduct(e) {
            e.preventDefault();
            
            const id = editingProductId || Date.now().toString();
            const hasDiscount = document.getElementById('discountToggle').classList.contains('active');
            
            let discount = null;
            let discountPercentage = null;
            
            if (hasDiscount) {
                if (currentDiscountType === 'amount') {
                    discount = parseFloat(document.getElementById('discountAmount').value) || null;
                } else {
                    discountPercentage = parseFloat(document.getElementById('discountPercentage').value) || null;
                }
            }
            
            // Get date and store based on mode
            let date, store;
            if (currentMode === 'shopping' && shoppingSession) {
                date = shoppingSession.date;
                store = shoppingSession.store;
            } else {
                date = document.getElementById('purchaseDate').value;
                store = document.getElementById('storeName').value;
            }
            
            const product = {
                id,
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value,
                price: parseFloat(document.getElementById('productPrice').value),
                date: date,
                store: store,
                discount,
                discountPercentage
            };
            
            if (editingProductId) {
                products = products.map(p => p.id === id ? product : p);
            } else {
                products.push(product);
            }
            
            localStorage.setItem('priceHistory', JSON.stringify(products));
            
            // Different behavior based on mode
            if (currentMode === 'shopping' && shoppingSession && !editingProductId) {
                // In shopping mode, clear form and stay open
                addAnotherProduct();
                renderProducts();
                updateStats();
                updateQuickAdd();
            } else {
                // In single mode or when editing, close modal
                closeModal();
                renderProducts();
                updateStats();
                updateQuickAdd();
                shoppingSession = null; // Reset session after closing
            }
        }

        function renderProducts() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sort = document.getElementById('sortSelect').value;
            
            let filtered = products.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.store.toLowerCase().includes(search)
            );
            
            // Sort
            filtered.sort((a, b) => {
                switch(sort) {
                    case 'date-desc': return new Date(b.date) - new Date(a.date);
                    case 'date-asc': return new Date(a.date) - new Date(b.date);
                    case 'name-asc': return a.name.localeCompare(b.name);
                    case 'name-desc': return b.name.localeCompare(a.name);
                    case 'price-asc': return getFinalPrice(a) - getFinalPrice(b);
                    case 'price-desc': return getFinalPrice(b) - getFinalPrice(a);
                    default: return 0;
                }
            });
            
            const container = document.getElementById('productsList');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üõí</div>
                        <div class="empty-title">Nessun prodotto</div>
                        <div class="empty-text">Tocca + per aggiungere il tuo primo acquisto</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(product => {
                const finalPrice = getFinalPrice(product);
                const hasDiscount = product.discount || product.discountPercentage;
                const originalPrice = hasDiscount ? product.price : null;
                
                return `
                    <div class="product-item" onclick="showProductDetail('${product.id}')">
                        <div class="product-header">
                            <div class="product-name">${product.name}${product.brand ? ` - ${product.brand}` : ''}</div>
                            <div class="product-price-container">
                                ${originalPrice ? `<div class="original-price">‚Ç¨${originalPrice.toFixed(2)}</div>` : ''}
                                <div class="product-price ${hasDiscount ? 'discounted' : ''}">‚Ç¨${finalPrice.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="product-details">
                            <div>üè™ ${product.store}</div>
                            <div>üìÖ ${formatDate(product.date)}</div>
                        </div>
                        ${hasDiscount ? `
                            <div class="discount-badge">
                                üè∑Ô∏è ${product.discountPercentage ? 
                                    `Sconto ${product.discountPercentage}%` : 
                                    `Sconto ‚Ç¨${product.discount.toFixed(2)}`
                                }
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getFinalPrice(product) {
            if (product.discount) {
                return Math.max(0, product.price - product.discount);
            } else if (product.discountPercentage) {
                return product.price * (1 - product.discountPercentage / 100);
            }
            return product.price;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function showProductDetail(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            const finalPrice = getFinalPrice(product);
            const hasDiscount = product.discount || product.discountPercentage;
            
            // Get related products
            const related = products.filter(p => p.name === product.name).sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            const prices = related.map(p => getFinalPrice(p));
            const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            
            const content = `
                <div class="card">
                    <h3 style="margin-bottom: 16px;">Dettagli Acquisto</h3>
                    <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Prodotto</span>
                        <span style="font-weight: 600;">${product.name}</span>
                    </div>
                    ${product.brand ? `
                    <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Marca</span>
                        <span style="font-weight: 600;">${product.brand}</span>
                    </div>
                    ` : ''}
                    <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Negozio</span>
                        <span style="font-weight: 600;">${product.store}</span>
                    </div>
                    <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Data</span>
                        <span style="font-weight: 600;">${formatDate(product.date)}</span>
                    </div>
                    ${hasDiscount ? `
                        <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Prezzo originale</span>
                            <span style="text-decoration: line-through;">‚Ç¨${product.price.toFixed(2)}</span>
                        </div>
                        <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Sconto</span>
                            <span style="color: var(--warning-color); font-weight: 600;">
                                ${product.discountPercentage ? 
                                    `-${product.discountPercentage}%` : 
                                    `-‚Ç¨${product.discount.toFixed(2)}`
                                }
                            </span>
                        </div>
                    ` : ''}
                    <div style="padding: 12px 0; display: flex; justify-content: space-between; border-top: 2px solid var(--background); margin-top: 8px;">
                        <span style="font-weight: 700;">Prezzo pagato</span>
                        <span style="font-size: 22px; font-weight: 700; color: ${hasDiscount ? 'var(--success-color)' : 'var(--text-primary)'};">‚Ç¨${finalPrice.toFixed(2)}</span>
                    </div>
                </div>
                
                ${related.length > 1 ? `
                    <div class="card">
                        <h3 style="margin-bottom: 16px;">Storico "${product.name}"</h3>
                        <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Prezzo medio</span>
                            <span style="font-weight: 600;">‚Ç¨${avgPrice.toFixed(2)}</span>
                        </div>
                        <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Min - Max</span>
                            <span style="font-weight: 600;">‚Ç¨${minPrice.toFixed(2)} - ‚Ç¨${maxPrice.toFixed(2)}</span>
                        </div>
                        <div style="padding: 8px 0; display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Acquisti totali</span>
                            <span style="font-weight: 600;">${related.length}</span>
                        </div>
                        
                        <div class="mini-chart" style="margin-top: 16px;">
                            ${related.slice(0, 10).reverse().map(p => {
                                const price = getFinalPrice(p);
                                const height = ((price - minPrice) / (maxPrice - minPrice || 1)) * 100;
                                return `<div class="chart-bar" style="height: ${Math.max(height, 10)}%"></div>`;
                            }).join('')}
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: 8px;">
                            Ultimi 10 acquisti
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Tutti gli acquisti</h3>
                        ${related.map(r => `
                            <div style="padding: 12px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--background);">
                                <div>
                                    <div style="font-weight: 500;">${r.store}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 2px;">${formatDate(r.date)}</div>
                                </div>
                                <div style="font-weight: 600; font-size: 17px; ${r.id === product.id ? 'color: var(--primary-color);' : ''}">
                                    ‚Ç¨${getFinalPrice(r).toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div class="action-buttons">
                    <button class="action-btn" style="background: var(--primary-color); color: white;" onclick="editProduct('${product.id}')">
                        ‚úèÔ∏è Modifica
                    </button>
                    <button class="action-btn" style="background: var(--danger-color); color: white;" onclick="deleteProduct('${product.id}')">
                        üóëÔ∏è Elimina
                    </button>
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML = content;
            document.getElementById('detailModal').classList.add('active');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            // Force single mode when editing
            currentMode = 'single';
            shoppingSession = null;
            
            editingProductId = id;
            document.getElementById('modalTitle').textContent = 'Modifica Prodotto';
            document.getElementById('editingId').value = id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productBrand').value = product.brand || '';
            document.getElementById('productPrice').value = product.price;
            document.getElementById('purchaseDate').value = product.date;
            document.getElementById('storeName').value = product.store;
            
            switchMode('single');
            
            const hasDiscount = product.discount || product.discountPercentage;
            const toggle = document.getElementById('discountToggle');
            
            if (hasDiscount) {
                toggle.classList.add('active');
                document.getElementById('discountSection').style.display = 'block';
                
                if (product.discount) {
                    currentDiscountType = 'amount';
                    document.querySelectorAll('#discountTypeControl .segment')[0].classList.add('active');
                    document.querySelectorAll('#discountTypeControl .segment')[1].classList.remove('active');
                    document.getElementById('discountAmountGroup').style.display = 'block';
                    document.getElementById('discountPercentageGroup').style.display = 'none';
                    document.getElementById('discountAmount').value = product.discount;
                } else {
                    currentDiscountType = 'percentage';
                    document.querySelectorAll('#discountTypeControl .segment')[0].classList.remove('active');
                    document.querySelectorAll('#discountTypeControl .segment')[1].classList.add('active');
                    document.getElementById('discountAmountGroup').style.display = 'none';
                    document.getElementById('discountPercentageGroup').style.display = 'block';
                    document.getElementById('discountPercentage').value = product.discountPercentage;
                }
            } else {
                toggle.classList.remove('active');
                document.getElementById('discountSection').style.display = 'none';
            }
            
            updateFinalPricePreview();
            closeDetailModal();
            document.getElementById('addModal').classList.add('active');
        }

        function deleteProduct(id) {
            if (confirm('Sei sicuro di voler eliminare questo prodotto?')) {
                products = products.filter(p => p.id !== id);
                localStorage.setItem('priceHistory', JSON.stringify(products));
                closeDetailModal();
                renderProducts();
                updateStats();
                updateQuickAdd();
            }
        }

        function updateStats() {
            const totalSpent = products.reduce((sum, p) => sum + getFinalPrice(p), 0);
            const totalPurchases = products.length;
            const avgPrice = totalPurchases > 0 ? totalSpent / totalPurchases : 0;
            const uniqueProducts = new Set(products.map(p => `${p.name}|||${p.brand}`)).size;
            
            document.getElementById('totalSpent').textContent = `‚Ç¨${totalSpent.toFixed(2)}`;
            document.getElementById('totalPurchases').textContent = totalPurchases;
            document.getElementById('avgPrice').textContent = `‚Ç¨${avgPrice.toFixed(2)}`;
            document.getElementById('uniqueProducts').textContent = uniqueProducts;
            document.getElementById('totalProductsCount').textContent = totalPurchases;
            
            // Update store filters
            const stores = ['', ...new Set(products.map(p => p.store))];
            const spendingStoreFilter = document.getElementById('spendingStoreFilter');
            const productStoreFilter = document.getElementById('productStoreFilter');
            
            const currentSpendingStore = spendingStoreFilter.value;
            const currentProductStore = productStoreFilter.value;
            
            spendingStoreFilter.innerHTML = stores.map(s => 
                `<option value="${s}">${s || 'Tutti i negozi'}</option>`
            ).join('');
            productStoreFilter.innerHTML = stores.map(s => 
                `<option value="${s}">${s || 'Tutti i negozi'}</option>`
            ).join('');
            
            spendingStoreFilter.value = currentSpendingStore;
            productStoreFilter.value = currentProductStore;
            
            // Update product selector
            const productGroups = {};
            products.forEach(p => {
                const key = `${p.name}|||${p.brand}`;
                if (!productGroups[key]) {
                    productGroups[key] = [];
                }
                productGroups[key].push(p);
            });
            
            const productChartSelect = document.getElementById('productChartSelect');
            const currentProduct = productChartSelect.value;
            
            productChartSelect.innerHTML = '<option value="">Seleziona un prodotto</option>' +
                Object.keys(productGroups).sort().map(key => {
                    const [name, brand] = key.split('|||');
                    const label = brand ? `${name} - ${brand}` : name;
                    return `<option value="${key}">${label}</option>`;
                }).join('');
            
            productChartSelect.value = currentProduct;
            
            // Top products
            const topProducts = Object.entries(productGroups)
                .map(([key, purchases]) => {
                    const [name, brand] = key.split('|||');
                    return {
                        name,
                        brand,
                        count: purchases.length,
                        avgPrice: purchases.reduce((sum, p) => sum + getFinalPrice(p), 0) / purchases.length
                    };
                })
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            const topList = document.getElementById('topProductsList');
            if (topProducts.length === 0) {
                topList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div class="empty-text">Nessun dato disponibile</div>
                    </div>
                `;
            } else {
                topList.innerHTML = topProducts.map(item => `
                    <div class="product-item" onclick="showProductHistoryByKey('${item.name}|||${item.brand}')">
                        <div class="product-header">
                            <div class="product-name">${item.name}${item.brand ? ` - ${item.brand}` : ''}</div>
                            <div class="product-price-container">
                                <div class="product-price">‚Ç¨${item.avgPrice.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="product-details">
                            <div>üì¶ ${item.count} acquisti</div>
                            <div>üìä Prezzo medio</div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Update charts if on stats tab
            if (document.getElementById('statsTab').classList.contains('active')) {
                updateSpendingChart();
                if (productChartSelect.value) {
                    updateProductChart();
                }
            }
        }

        function showProductHistoryByKey(key) {
            const [name, brand] = key.split('|||');
            const related = products.filter(p => p.name === name && p.brand === brand);
            if (related.length > 0) {
                showProductDetail(related[0].id);
            }
        }

        // Charts
        function updateSpendingChart(period) {
            if (period) {
                currentSpendingPeriod = period;
                // Update button states
                document.querySelectorAll('.chart-filters button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
            
            const storeFilter = document.getElementById('spendingStoreFilter').value;
            let filtered = products;
            if (storeFilter) {
                filtered = products.filter(p => p.store === storeFilter);
            }
            
            // Group by period
            const grouped = {};
            filtered.forEach(p => {
                const date = new Date(p.date);
                let key;
                
                if (currentSpendingPeriod === 'week') {
                    // Get week start (Monday)
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    const weekStart = new Date(date.setDate(diff));
                    key = weekStart.toISOString().split('T')[0];
                } else if (currentSpendingPeriod === 'month') {
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                } else { // year
                    key = date.getFullYear().toString();
                }
                
                if (!grouped[key]) {
                    grouped[key] = 0;
                }
                grouped[key] += getFinalPrice(p);
            });
            
            // Sort and prepare data
            const sorted = Object.entries(grouped).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(([key]) => {
                if (currentSpendingPeriod === 'week') {
                    return new Date(key).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                } else if (currentSpendingPeriod === 'month') {
                    const [year, month] = key.split('-');
                    return new Date(year, month - 1).toLocaleDateString('it-IT', { month: 'short', year: '2-digit' });
                } else {
                    return key;
                }
            });
            const data = sorted.map(([, value]) => value);
            
            const ctx = document.getElementById('spendingChart');
            
            if (spendingChartInstance) {
                spendingChartInstance.destroy();
            }
            
            spendingChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Spesa Totale',
                        data: data,
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `‚Ç¨${context.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => `‚Ç¨${value.toFixed(0)}`
                            }
                        }
                    }
                }
            });
        }

        function updateProductChart() {
            const productKey = document.getElementById('productChartSelect').value;
            const storeFilter = document.getElementById('productStoreFilter').value;
            
            if (!productKey) {
                if (productChartInstance) {
                    productChartInstance.destroy();
                    productChartInstance = null;
                }
                return;
            }
            
            const [name, brand] = productKey.split('|||');
            let filtered = products.filter(p => p.name === name && p.brand === brand);
            
            if (storeFilter) {
                filtered = filtered.filter(p => p.store === storeFilter);
            }
            
            const sorted = filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sorted.map(p => formatDate(p.date));
            const data = sorted.map(p => getFinalPrice(p));
            
            const ctx = document.getElementById('productChart');
            
            if (productChartInstance) {
                productChartInstance.destroy();
            }
            
            productChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Prezzo',
                        data: data,
                        borderColor: '#34C759',
                        backgroundColor: 'rgba(52, 199, 89, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#34C759'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `‚Ç¨${context.parsed.y.toFixed(2)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: (value) => `‚Ç¨${value.toFixed(2)}`
                            }
                        }
                    }
                }
            });
        }

        function exportData() {
            const dataStr = JSON.stringify(products, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `storico-prezzi-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Dati esportati con successo!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('Vuoi sostituire tutti i dati o aggiungerli a quelli esistenti?\n\nOK = Sostituisci\nAnnulla = Aggiungi')) {
                        products = imported;
                    } else {
                        products = [...products, ...imported];
                    }
                    localStorage.setItem('priceHistory', JSON.stringify(products));
                    renderProducts();
                    updateStats();
                    alert('Importazione completata!');
                } catch (error) {
                    alert('Errore durante l\'importazione: file non valido');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function deleteAllData() {
            if (confirm('Sei sicuro di voler eliminare TUTTI i dati?\n\nQuesta azione non pu√≤ essere annullata.')) {
                if (confirm('Confermi l\'eliminazione di tutti i ' + products.length + ' prodotti?')) {
                    products = [];
                    localStorage.setItem('priceHistory', JSON.stringify(products));
                    renderProducts();
                    updateStats();
                    updateQuickAdd();
                    alert('Tutti i dati sono stati eliminati');
                }
            }
        }

        // iOS Widget Support - expose data for Shortcuts app
        window.getPriceHistoryData = function() {
            return {
                products: products,
                totalSpent: products.reduce((sum, p) => sum + getFinalPrice(p), 0),
                totalPurchases: products.length,
                lastUpdate: new Date().toISOString()
            };
        };

        window.addProductViaWidget = function(name, brand, price, store, date) {
            const product = {
                id: Date.now().toString(),
                name: name,
                brand: brand || '',
                price: parseFloat(price),
                date: date || new Date().toISOString().split('T')[0],
                store: store,
                discount: null,
                discountPercentage: null
            };
            
            products.push(product);
            localStorage.setItem('priceHistory', JSON.stringify(products));
            return { success: true, id: product.id };
        };

        // Prevent zoom on input focus (iOS)
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // Close modals on background click
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeDetailModal();
        });
        
        document.getElementById('quickAddModal').addEventListener('click', function(e) {
            if (e.target === this) closeQuickAddModal();
        });
    </script>
</body>
</html>